
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Dashboard Template Â· Bootstrap v5.0</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/dashboard/">

     <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
      <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <!-- Bootstrap core CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Favicons -->
<link rel="apple-touch-icon" href="/docs/5.0/assets/img/favicons/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/docs/5.0/assets/img/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/docs/5.0/assets/img/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/docs/5.0/assets/img/favicons/manifest.json">
<link rel="mask-icon" href="/docs/5.0/assets/img/favicons/safari-pinned-tab.svg" color="#7952b3">
<link rel="icon" href="/docs/5.0/assets/img/favicons/favicon.ico">
<meta name="theme-color" content="#7952b3">


    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="https://getbootstrap.com/docs/5.0/examples/dashboard/dashboard.css" rel="stylesheet">
  </head>
  <body>
    
<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Company name</a>
  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search">
  <div class="navbar-nav">
    <div class="nav-item text-nowrap">
      <button onclick="logout()">Logout</button>

    </div>
  </div>
</header>

<div class="container-fluid">
  <div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column" id="navMenu">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">
              <span data-feather="home"></span>
              Dashboard
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard</h1>
        <div class="btn-toolbar mb-2 mb-md-0">


        </div>
      </div>
      <h1>Welcome to Your Dashboard</h1>
    <div id="userInfo" class="alert alert-info">
        <!-- User details will be inserted here -->
    </div>
        <div id="dataContainer" class="container mt-4">
    <h2 id="tableTitle"></h2>
           <!-- Add Buttons to Add Buyer or Seller -->
    <div class="mb-3" id="adminActions">
        <button id="addBuyer" class="btn btn-primary me-2">Add Buyer</button>
        <button id="addSeller" class="btn btn-secondary">Add Seller</button>
    </div>
    <table id="dataTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be populated here -->
        </tbody>
    </table>
</div>
        <div id="kpiCardContainer" class="container mt-4">
    <!-- The card will be populated dynamically here -->
</div>


        <div id="registrationModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Registration</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="registrationForm">
                        <div class="form-group">
                            <label for="name">Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="role">Role</label>
                            <select id="role" class="form-control" required>
                                <option value="Buyer">Buyer</option>
                                <option value="Seller">Seller</option>
                                <option value="Superadmin">Superadmin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="form-group">
                            <label for="password2">Confirm Password</label>
                            <input type="password" class="form-control" id="password2" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

        <div class="modal fade" id="userDetailsModal" tabindex="-1" role="dialog" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>ID:</strong> <span id="modalUserId"></span></p>
                <p><strong>Name:</strong> <span id="modalUserName"></span></p>
                <p><strong>Email:</strong> <span id="modalUserEmail"></span></p>
                <p><strong>Role:</strong> <span id="modalUserRole"></span></p>
                <p><strong>Status:</strong> <span id="modalUserStatus"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    </main>
  </div>
</div>


    <script src="/docs/5.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE" crossorigin="anonymous">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://getbootstrap.com/docs/5.0/examples/dashboard/dashboard.js"></script>

  <script>
    async function logout() {
    const refreshToken = localStorage.getItem('refresh_token');
     const accessToken = localStorage.getItem('access_token');// Get the refresh token from local storage
    console.log("Clicked");
    if (!refreshToken) {
        console.error('No refresh token found.');
        return;
    }

    try {
        const response = await fetch('http://127.0.0.1:8000/api/users/logout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`,
            },
            body: JSON.stringify({ refresh_token: refreshToken }), // Send the refresh token
        });

        if (response.ok) {
            // Handle successful logout
            console.log('Logged out successfully.');
            localStorage.removeItem('access_token'); // Remove access token
            localStorage.removeItem('refresh_token'); // Remove refresh token
            // Redirect to login or show a message
            window.location.href = '/'; // Example redirection to login page
        } else {
            const errorData = await response.json();
            console.error('Logout failed:', errorData.detail);
        }
    } catch (error) {
        console.error('Error during logout:', error);
    }
}

  </script>
  <script>
    function displayUserInfo() {
        const userName = localStorage.getItem('user_name');
        const userRole = localStorage.getItem('user_role');
        console.log("***********************");
        console.log(userName);
        console.log(userRole);

        // Check if user details are available
        if (userName && userRole) {
            document.getElementById('userInfo').innerHTML = `
                <strong>Name:</strong> ${userName}<br>
                <strong>Role:</strong> ${userRole}
            `;
        } else {
            document.getElementById('userInfo').innerHTML = `
                <strong>Error:</strong> User details not found.
            `;
        }
    }
    displayUserInfo();
  </script>

  <script>
    // After user data has been stored in localStorage
  document.addEventListener('DOMContentLoaded', function() {
    const userRole = localStorage.getItem('user_role');
    const navMenu = document.getElementById('navMenu');
     console.log("*******************")// Make sure to replace 'navMenu' with the actual ID of your nav element
    console.log(userRole);

    // Check if the user is not Superadmin
    if (userRole !== 'Superadmin') {
        // Hide the admin action buttons
        document.getElementById('dataContainer').style.display = 'none';

    }
    // Check if the user role is superadmin
    if (userRole === 'Superadmin') {
        document.getElementById('kpiCardContainer').style.display = 'none';
        // Create and append Buyers menu item
        const buyersMenuItem = document.createElement('li');
        buyersMenuItem.className = 'nav-item';
        buyersMenuItem.innerHTML = `
            <a class="nav-link" href="#" id="view-buyers">
                <span data-feather="users"></span>
                Buyers
            </a>
        `;
        navMenu.appendChild(buyersMenuItem); // Append to the navigation menu

        // Create and append Sellers menu item
        const sellersMenuItem = document.createElement('li');
        sellersMenuItem.className = 'nav-item';
        sellersMenuItem.innerHTML = `
            <a class="nav-link" href="#" id="view-sellers">
                <span data-feather="shopping-cart"></span>
                Sellers
            </a>
        `;
        navMenu.appendChild(sellersMenuItem); // Append to the navigation menu
        // Now, add the event listeners here after the elements have been created
        document.getElementById('view-buyers').addEventListener('click', function() {
            loadData('buyers');
        });

        document.getElementById('view-sellers').addEventListener('click', function() {
            loadData('sellers');
        });
        // Open registration modal and handle button clicks
        document.getElementById('addBuyer').addEventListener('click', function() {
            openRegistrationModal('Buyer');
        });

        document.getElementById('addSeller').addEventListener('click', function() {
            openRegistrationModal('Seller');
        });

    }
    if (userRole === 'Buyer') {
        // Fetch KPI data from the API
        document.getElementById('kpiCardContainer').style.display = 'block';
        const accessToken = localStorage.getItem('access_token');
        const apiUrl = `http://127.0.0.1:8000/api/buyers/kpi-card/`; // Update the base URL

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch KPI data');
            return response.json();
        })
        .then(data => {
            // Call function to create and display the KPI card
            displayKpiCard(data.data);
        })
        .catch(error => {
            console.error('Error fetching KPI data:', error);
        });
    }

    if (userRole === 'Seller') {
        // Fetch KPI data from the API
        document.getElementById('kpiCardContainer').style.display = 'block';
        const accessToken = localStorage.getItem('access_token');
        const apiUrl = `http://127.0.0.1:8000/api/sellers/seller-kpi-card/`; // Update the base URL

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch KPI data');
            return response.json();
        })
        .then(data => {
            // Call function to create and display the KPI card
            displayKpiCard(data.data);
        })
        .catch(error => {
            console.error('Error fetching KPI data:', error);
        });
    }
});

  </script>
  <script>

// Function to load data based on the type (buyers or sellers)
function loadData(type) {
    const accessToken = localStorage.getItem('access_token');
    const apiUrl = `http://127.0.0.1:8000/api/${type}/list/`; // Replace with the correct API endpoint

    // Set the table title based on type
    document.getElementById('tableTitle').textContent = type === 'buyers' ? 'Buyers List' : 'Sellers List';

    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`, // Use the access token
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch data');
        return response.json();
    })
    .then(data => {
        populateTable(data);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

// Function to populate the table with data
function populateTable(data) {
    const tableBody = document.querySelector('#dataTable tbody');
    tableBody.innerHTML = ''; // Clear existing rows

    data.data.forEach(item => {
    if (item.is_active) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.email}</td>
            <td>
                <button class="btn btn-info view-button" data-id="${item.id}" data-type="${item.role}">View</button>
                <button class="btn btn-danger delete-button" data-id="${item.id}" data-type="${item.role}">Delete</button>
            </td>
        `;
        tableBody.appendChild(row);
        }
    });

    // Add event listeners for the action buttons
    addActionListeners();
}

// Function to add event listeners to action buttons
function addActionListeners() {
    // Add event listeners for view buttons
    document.querySelectorAll('.view-button').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const type = this.getAttribute('data-type'); // Get the type (buyer or seller)
            viewDetails(id, type); // Call the view function
        });
    });

    // Add event listeners for delete buttons
    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const type = this.getAttribute('data-type'); // Get the type (buyer or seller)
            deleteUser(id, type); // Call the delete function
        });
    });
}


  </script>

  <script>
      function openRegistrationModal(role) {
        document.getElementById('role').value = role; // Set the role in the dropdown
        $('#registrationModal').modal('show'); // Use Bootstrap modal
    }
    // Handle the registration form submission
    document.getElementById('registrationForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission
        const email = document.getElementById('email').value;
        const name = document.getElementById('name').value;
        const role = document.getElementById('role').value;
        const password = document.getElementById('password').value;
        const password2 = document.getElementById('password2').value;

        const userData = {
            email: email,
            name: name,
            role: role,
            password: password,
            password2: password2
        };

        // Call the registration API
        registerUser(userData);
    });

    function registerUser(userData) {
        const accessToken = localStorage.getItem('access_token');
        const apiUrl = `http://127.0.0.1:8000/api/users/registration/`; // Update with your registration endpoint

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        })
        .then(response => {
            if (!response.ok) throw new Error('Registration failed');
            return response.json();
        })
        .then(data => {
            console.log('User registered successfully:', data);
            // Close modal and reload data
            $('#registrationModal').modal('hide');
            loadData('buyers');
            loadData('sellers');// Reload the buyers list or sellers based on your need
        })
        .catch(error => {
            console.error('Error during registration:', error);
        });
    }
  </script>

  <script>
  function viewDetails(id, type) {
    const accessToken = localStorage.getItem('access_token');
    let apiUrl; // Declare apiUrl outside the if blocks

    // Assign the appropriate API URL based on type (Seller or Buyer)
    if (type === "Seller") {
        apiUrl = `http://127.0.0.1:8000/api/sellers/${id}/`;
    } else if (type === "Buyer") {
        apiUrl = `http://127.0.0.1:8000/api/buyers/${id}/`;
    }


    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch details');
        return response.json();
    })
    .then(user => {
        // Populate the modal with user details
        document.getElementById('modalUserId').textContent = user.data.id;
        document.getElementById('modalUserName').textContent = user.data.name;
        document.getElementById('modalUserEmail').textContent = user.data.email;
        document.getElementById('modalUserRole').textContent = user.data.role;
        document.getElementById('modalUserStatus').textContent = user.data.is_active ? 'Active' : 'Inactive';

        // Show the modal
        $('#userDetailsModal').modal('show');
    })
    .catch(error => {
        console.error('Error fetching user details:', error);
    });
}

function deleteUser(id, type) {
    const accessToken = localStorage.getItem('access_token');
    let apiUrl; // Declare apiUrl outside the if blocks

    // Assign the appropriate API URL based on type (Seller or Buyer)
    if (type === "Seller") {
        apiUrl = `http://127.0.0.1:8000/api/sellers/${id}/`; // Update with your delete endpoint
    } else if (type === "Buyer") {
        apiUrl = `http://127.0.0.1:8000/api/buyers/${id}/`; // Update with your delete endpoint
    }

    // Ensure apiUrl is defined before making the request
    if (apiUrl) {
        fetch(apiUrl, {
            method: 'DELETE', // Use PATCH for soft delete
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to delete user');
            console.log(`Deleted item with ID: ${id}`);
            loadData(type === 'Buyer' ? 'buyers' : 'sellers'); // Reload data based on type
        })
        .catch(error => {
            console.error('Error during deletion:', error);
        });
    } else {
        console.error('API URL not defined');
    }
}
  </script>

  <script>
      function displayKpiCard(kpiData) {
    const kpiCardContainer = document.getElementById('kpiCardContainer');
    console.log("In KPI card")

    // Create card structure
    const cardHtml = `
        <div class="card">
            <div class="card-header">
                KPI Dashboard
            </div>
            <div class="card-body">
                <h5 class="card-title">KPI Overview</h5>
                <p class="card-text">Total Purchases: ${kpiData.total_purchases}</p>
                <p class="card-text">In Process Purchases: ${kpiData.in_process}</p>
                <p class="card-text">Approved Purchases: ${kpiData.approved}</p>
                <p class="card-text">Rejected Purchases: ${kpiData.rejected}</p>
            </div>
        </div>
    `;

    // Insert the card HTML into the container
    kpiCardContainer.innerHTML = cardHtml;
}
  </script>
  </body>
</html>
